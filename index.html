<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ˜æ—¥ã®é‹å‹¢ã‚¬ãƒãƒ£</title>
  <style>
    :root{ --bg:#0f172a; --panel:#101625cc; --text:#e5e7eb; --muted:#94a3b8; --accent:#fbbf24; --accent2:#f59e0b; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;display:grid;place-items:center;background:radial-gradient(80vw 80vh at 50% -10%,#182236,#0b1220);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,sans-serif;color:var(--text)}
    .card{width:min(720px,94vw);background:linear-gradient(180deg,#0b1220dd,#0b1220b0);border:1px solid #1f2937;border-radius:20px;padding:24px 20px;box-shadow:0 10px 30px #0008}
    h1{margin:6px 0 6px;font-size:clamp(22px,4vw,28px)}
    p.sub{margin:0 0 12px;color:var(--muted);font-size:14px}
    .stage{position:relative;height:300px;border-radius:16px;background:linear-gradient(180deg,#0b1220,#0b1226);border:1px dashed #334155;overflow:hidden;display:grid;place-items:center}
    .cookieWrap{position:absolute;top:-200px;width:220px;height:200px;display:grid;place-items:center;pointer-events:none}
    .cookieWrap.drop{animation:drop 900ms cubic-bezier(.2,.9,.2,1) forwards}
    @keyframes drop{0%{transform:translateY(-220px) scale(.9) rotate(-6deg)}70%{transform:translateY(260px) scale(1) rotate(4deg)}100%{transform:translateY(220px) rotate(0deg)}}
    .cookieWrap.bob{animation:bob 2.4s ease-in-out infinite}
    @keyframes bob{0%,100%{transform:translateY(220px)}50%{transform:translateY(214px)}}
    .cookie.crack{animation:crack 500ms ease forwards}
    @keyframes crack{0%{filter:drop-shadow(0 6px 12px #0008)}100%{filter:drop-shadow(0 16px 26px #0008)}}
    .leftHalf.fly{animation:flyL 650ms cubic-bezier(.2,.7,.1,1) forwards}
    .rightHalf.fly{animation:flyR 650ms cubic-bezier(.2,.7,.1,1) forwards}
    @keyframes flyL{to{transform:translate(-120px,-30px) rotate(-22deg)}}
    @keyframes flyR{to{transform:translate(120px,-10px) rotate(22deg)}}
    .slip{position:absolute;bottom:120px;left:50%;transform:translate(-50%,40px) rotate(-2deg);min-width:260px;background:#fff;color:#111;border-radius:6px;padding:10px 14px;border:1px solid #e5e7eb;box-shadow:0 10px 20px #0007;opacity:0}
    .slip.show{animation:slipOut 700ms cubic-bezier(.2,.8,.2,1) forwards}
    @keyframes slipOut{from{opacity:0;transform:translate(-50%,60px) rotate(-4deg)}to{opacity:1;transform:translate(-50%,-10px) rotate(0deg)}}
    .slip .label{font-size:12px;color:#6b7280}
    .slip .fortune{font-weight:800;font-size:20px;letter-spacing:.02em}
    .slip .tip{margin-top:4px;font-size:12px;color:#4b5563}
    .btns{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px}
    button{appearance:none;border:none;border-radius:14px;padding:12px 16px;cursor:pointer;font-weight:700;letter-spacing:.02em;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#3a2200;transition:transform .08s ease,box-shadow .08s ease;box-shadow:0 6px 16px #0008}
    button:hover{transform:translateY(-1px)} button:active{transform:translateY(1px)}
    button.secondary{background:#0f172a;color:#cbd5e1;border:1px solid #334155}
    .history{margin-top:14px;font-size:13px;color:var(--muted)}
    .history ul{margin:6px 0 0;padding-left:18px;max-height:140px;overflow:auto}
    .counter{font-size:12px;color:var(--muted);margin-top:4px}
    footer{margin-top:16px;font-size:12px;color:#748096}
  </style>
</head>
<body>
  <main class="card" role="main">
    <h1>æ˜æ—¥ã®é‹å‹¢ã‚¬ãƒãƒ£</h1>
    <p class="sub">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã‚¯ãƒƒã‚­ãƒ¼ãŒé™ã‚Šã¦å‰²ã‚Œã¦ã€ãŠã¿ãã˜ãŒå‡ºã‚‹ã€‚</p>

    <section class="stage" aria-live="polite" aria-atomic="true">
      <div class="cookieWrap" id="cookieWrap" aria-hidden="true">
        <svg id="cookieSvg" class="cookie" width="200" height="160" viewBox="0 0 200 160" role="img" aria-label="ãƒ•ã‚©ãƒ¼ãƒãƒ¥ãƒ¼ãƒ³ã‚¯ãƒƒã‚­ãƒ¼">
          <defs>
            <linearGradient id="g1" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0%" stop-color="#fbbf24"/><stop offset="100%" stop-color="#d97706"/>
            </linearGradient>
          </defs>
          <g id="cookieGroup">
            <path id="whole" d="M30 100c0-38 38-70 70-70s70 32 70 70c0 18-14 28-30 28-14 0-26-6-40-6s-26 6-40 6c-16 0-30-10-30-28z" fill="url(#g1)" stroke="#b45309" stroke-width="2"/>
            <path id="crack" d="M100 36 L100 126" stroke="#b45309" stroke-width="2" stroke-dasharray="6 6" opacity="0"/>
          </g>
          <g id="leftHalf" class="leftHalf" opacity="0">
            <path d="M30 100c0-38 38-70 70-70v88c-14 0-26 6-40 6-16 0-30-10-30-24z" fill="url(#g1)" stroke="#b45309" stroke-width="2"/>
          </g>
          <g id="rightHalf" class="rightHalf" opacity="0">
            <path d="M100 30c32 0 70 32 70 70 0 14-14 24-30 24-14 0-26-6-40-6V30z" fill="url(#g1)" stroke="#b45309" stroke-width="2"/>
          </g>
        </svg>
      </div>

      <div class="slip" id="slip">
        <div class="label">ãŠã¿ãã˜</div>
        <div class="fortune" id="slipFortune">â€”</div>
        <div class="tip" id="slipTip"></div>
      </div>
    </section>

    <div class="btns">
      <button id="roll">æ˜æ—¥ã®é‹å‹¢ã‚’å¼•ã</button>
      <button id="copy" class="secondary">ã‚³ãƒ”ãƒ¼</button>
      <button id="share" class="secondary">ã‚·ã‚§ã‚¢</button>
      <button id="reset" class="secondary">å±¥æ­´ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="counter" id="counter">å›ã—ãŸå›æ•°: 0</div>
    <div class="history" id="history">å±¥æ­´<ul id="histList"></ul></div>
    <footer><span id="footerDate"></span></footer>
  </main>

<script>
  // ===== ãƒ‡ãƒ¼ã‚¿ =====
  const FORTUNES = [
    { name: 'å¤ªé™½å‰', emoji: 'â˜€', tip: 'æœèµ·ããŸã‚‰å¤ªé™½ã‚’æµ´ã³ã‚ˆã†ï¼1æ—¥ã®ã„ã„ã‚¹ã‚¿ãƒ¼ãƒˆãŒãã‚Œã‚‹ã‚ˆï½' },
    { name: 'æµæ˜Ÿå‰', emoji: 'ğŸŒ ', tip: 'æ€ã„ã¤ã„ãŸå¥‡è·¡ã¯å¿˜ã‚Œãªã„ã†ã¡ã«ãƒ¡ãƒ¢ï¼æ¬¡ã®è»Œè·¡ã«ãªã‚‹ã‚ˆï¼' },
    { name: 'ç¬‘é¡”å‰', emoji: 'ğŸ˜†', tip: 'é¡ã‚’è¦‹ã¦ãƒ‹ã‚³ã£ã¦ã—ã‚ˆã†ï¼æ´»åŠ›ã‚¢ãƒƒãƒ—ã™ã‚‹ã‚ˆï¼' },
    { name: 'å†’é™ºå‰', emoji: 'ğŸš¶â€â™‚ï¸â€â¡ï¸', tip: 'ã„ã¤ã‚‚ã¨é•ã†é“ã‚’æ­©ã“ã†ï¼æ–°ã—ã„ç™ºè¦‹ãŒã‚ã‚‹ã‹ã‚‚ï¼Ÿ' },
    { name: 'é¢¨å‰', emoji: 'ğŸƒ', tip: 'å¤–ã§é¢¨ã‚’æ„Ÿã˜ã¦ã¿ã¦ï¼å°é¢¨ãŒæ¥ã‚‹ã‹ã‚‚ï½' },
    { name: 'ã‚«ãƒ•ã‚§å‰', emoji: 'â˜•', tip: 'ã²ã¨ã‚„ã™ã¿ã—ã¦ã‚‹ï¼Ÿæ˜æ—¥ã¯ã»ã£ã¨ä¸€æ¯ã¤ã“ã†ã­ï½' },
    { name: 'å¤©æ‰å‰', emoji: 'ğŸ§ ', tip: 'æ€ã„ã‚‚ã‚ˆã‚‰ã¬ã‚¢ã‚¤ãƒ‡ã‚¢ãŒé™ã‚Šã¦ããã†ï¼ãã‚“ãªã‚ãªãŸã¯å¤©æ‰ï¼' },
    { name: 'ãŠå–‹ã‚Šå‰', emoji: 'ğŸ’¬', tip: 'èª°ã‹ã¨è©±ã™ã¨ã€å¿ƒãŒè»½ããªã£ã¦é£›ã¹ã‚‹ã‹ã‚‚ã‚ˆï¼' },
    { name: 'æ•£æ­©å‰', emoji: 'ğŸ¾', tip: 'ãŠæ•£æ­©ã—ã«å¤–ã«å‡ºã‚ˆã†ï¼é‡‘æœ¨çŠ€ã®é¦™ã‚Šã‚’å—…ã’ã‚‹ãƒãƒ£ãƒ³ã‚¹ï¼' },
    { name: 'æ–™ç†å‰', emoji: 'ğŸ³', tip: 'ä½•ã‹ä½œã‚ã†ï¼æ€ã„ã‚‚ã‚ˆã‚‰ã¬ãŠã„ã—ã„å‘³ä»˜ã‘ãŒè¦‹ã¤ã‹ã‚‹äºˆæ„Ÿï¼' }
  ];

  // ===== å¤‰æ•°ç¾¤ =====
  const $ = sel => document.querySelector(sel);
  const wait = ms => new Promise(r=>setTimeout(r,ms));
  const counterEl = $('#counter');
  const histList = $('#histList');
  const slip = $('#slip');
  const slipFortune = $('#slipFortune');
  const slipTip = $('#slipTip');
  const cookieWrap = $('#cookieWrap');
  const cookieSvg = $('#cookieSvg');
  const crackPath = $('#crack');
  const leftHalf = $('#leftHalf');
  const rightHalf = $('#rightHalf');
  let state = JSON.parse(localStorage.getItem('tomorrow_fortune_v1')||'{"count":0,"history":[]}');

  // æœ¬ç•ªURLï¼ˆGitHub Pagesï¼‰
  const PUBLIC_URL = 'https://gogogobolder.github.io/fortune-cookie/';

  // ===== Util =====
  function chooseFortune(){
    const f = FORTUNES[Math.floor(Math.random()*FORTUNES.length)];
    slipFortune.textContent = `${f.emoji} ${f.name}`;
    slipTip.textContent = f.tip;
    return f;
  }
  function stamp(){
    const d=new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }
  function render(){
    counterEl.textContent = `å›ã—ãŸå›æ•°: ${state.count}`;
    histList.innerHTML = state.history.map(h=>`<li>${h.time}ï¼š${h.label}</li>`).join('');
  }
  // å…±æœ‰æ–‡ï¼ˆé‹å‹¢ï¼‹ãƒ’ãƒ³ãƒˆï¼‹ã‚¿ã‚°ï¼‰
  function buildShareText(){
    const title = 'æ˜æ—¥ã®é‹å‹¢ã‚¬ãƒãƒ£';
    const fortune = document.getElementById('slipFortune').textContent;
    const tip = document.getElementById('slipTip').textContent;
    const tags = '#æ˜æ—¥ã®é‹å‹¢ã‚¬ãƒãƒ£ #ãƒãƒ¼ã‚³ãƒ¼ãƒ‰';
    return `ã€${title}ã€‘\n${fortune}\nãƒ’ãƒ³ãƒˆï¼š${tip}\n${tags}`;
  }
  // é‹å‹¢ä»˜ãURLã‚’ä½œæˆ
  function buildShareUrl(){
    const fortune = document.getElementById('slipFortune').textContent;
    const tip = document.getElementById('slipTip').textContent;
    return `${PUBLIC_URL}?f=${encodeURIComponent(fortune)}&t=${encodeURIComponent(tip)}`;
  }
  function once(el, event){
    return new Promise(res=>{ const h=()=>{ el.removeEventListener(event,h); res(); }; el.addEventListener(event,h); });
  }
  function onceWithTimeout(el, event, ms){
    return new Promise(res=>{
      let done=false; const h=()=>{ if(done) return; done=true; el.removeEventListener(event,h); res(); };
      el.addEventListener(event,h);
      setTimeout(()=>{ if(done) return; done=true; el.removeEventListener(event,h); res(); }, ms);
    });
  }

  // ===== ã‚¢ãƒ‹ãƒ¡åˆ¶å¾¡ =====
  async function animateCookie(){
    // å‰å›ã®ç´™ã‚’éš ã™
    slip.classList.remove('show');
    slipFortune.textContent='â€”';
    slipTip.textContent='';

    // ãƒªã‚»ãƒƒãƒˆ
    crackPath.style.opacity=0;
    leftHalf.style.opacity=0; rightHalf.style.opacity=0;
    cookieSvg.style.opacity=1; cookieSvg.classList.remove('crack');
    cookieWrap.classList.remove('bob');

    // 1) Drop
    cookieWrap.classList.remove('drop'); void cookieWrap.offsetWidth;
    const pDrop = onceWithTimeout(cookieWrap,'animationend',1100);
    cookieWrap.classList.add('drop');
    await pDrop; cookieWrap.classList.add('bob');

    // 2) Crack hint
    crackPath.style.opacity=.9; cookieSvg.classList.add('crack');
    navigator.vibrate?.(40); await wait(200);

    // 3) Split
    crackPath.style.opacity=0; cookieSvg.style.opacity=0;
    leftHalf.style.opacity=1; rightHalf.style.opacity=1;
    leftHalf.classList.remove('fly'); rightHalf.classList.remove('fly');
    void leftHalf.offsetWidth;
    const pL = onceWithTimeout(leftHalf,'animationend',800);
    const pR = onceWithTimeout(rightHalf,'animationend',800);
    leftHalf.classList.add('fly'); rightHalf.classList.add('fly');
    await Promise.all([pL,pR]);

    // 4) ç´™ã‚’å‡ºã™
    chooseFortune();
    slip.classList.remove('show'); void slip.offsetWidth; slip.classList.add('show');
  }

  async function roll(){
    const btn = document.getElementById('roll');
    btn.disabled = true; btn.style.opacity = .7;
    try{
      await animateCookie();
      state.count++;
      state.history.unshift({ time: stamp(), label: slipFortune.textContent });
      state.history = state.history.slice(0,20);
      localStorage.setItem('tomorrow_fortune_v1', JSON.stringify(state));
      render();
    } finally { btn.disabled = false; btn.style.opacity = ''; }
  }

  // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
  $('#roll').addEventListener('click', roll);

  // ã‚³ãƒ”ãƒ¼ï¼šé‹å‹¢ï¼‹ãƒ’ãƒ³ãƒˆï¼‹URLï¼ˆé‹å‹¢ã¤ãï¼‰
  $('#copy').addEventListener('click', async () => {
    const text = `${buildShareText()}\n${buildShareUrl()}`;
    try{
      await navigator.clipboard.writeText(text);
      alert('é‹å‹¢ã¨ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã‚ˆ');
    }catch(e){
      console.error(e);
      const u = `https://twitter.com/intent/tweet?text=${encodeURIComponent(buildShareText())}&url=${encodeURIComponent(buildShareUrl())}`;
      window.open(u,'_blank');
    }
  });

  // ã‚·ã‚§ã‚¢ï¼šWeb Share API â†’ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ â†’ Twitterï¼ˆã„ãšã‚Œã‚‚é‹å‹¢ã¤ãURLï¼‰
  $('#share').addEventListener('click', async () => {
    const text = buildShareText();
    const url  = buildShareUrl();
    try{
      if(navigator.share){
        await navigator.share({ title:'æ˜æ—¥ã®é‹å‹¢ã‚¬ãƒãƒ£', text, url });
      }else{
        await navigator.clipboard.writeText(`${text}\n${url}`);
        alert('é‹å‹¢ã¨ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã‚ˆ');
      }
    }catch(e){
      console.error(e);
      const u = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
      window.open(u,'_blank');
    }
  });

  $('#reset').addEventListener('click', () => {
    state = { count:0, history:[] };
    localStorage.setItem('tomorrow_fortune_v1', JSON.stringify(state));
    render();
    slip.classList.remove('show');
  });

  // å…±æœ‰URLã§é–‹ã‹ã‚ŒãŸã‚‰ã€ãã®é‹å‹¢ã‚’æœ€åˆã‹ã‚‰è¡¨ç¤º
  (function hydrateFromQuery(){
    const sp = new URLSearchParams(location.search);
    if(!sp.has('f')) return;
    const f = sp.get('f');
    const t = sp.get('t') || '';
    slipFortune.textContent = f;
    slipTip.textContent = t;
    slip.classList.add('show');
    // ã‚¯ã‚¨ãƒªã‚’æ¶ˆã—ã¦URLã‚’ç¶ºéº—ã«ã—ãŸã„å ´åˆã¯æ¬¡ã®1è¡Œã‚’æœ‰åŠ¹åŒ–
    // history.replaceState(null, '', PUBLIC_URL);
  })();

  // åˆæœŸè¡¨ç¤º
  render();
  document.getElementById('footerDate').textContent = `Â© ${new Date().getFullYear()} Tomorrow Fortune Gacha`;
</script>
</body>
</html>
